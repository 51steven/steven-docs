分布式系统基础
====================
# 1 分布式系统概念
分布式系统：一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过**消息传递**进行**通信**和**协调**的系统。

分布式的特点：
- 分布性
- 对等性
- 并发性
- 缺乏全局时钟
- 故障随时会发生

### 大型网站架构图

<img src=".\images\101.png" alt="101"  />

如上图，zookeeper 可理解为各个节点组成分布式系统的指挥官（交通警察）。

# 2 分布式系统协调“方法论”

## 2.1 分布式系统带来的问题
分布式系统有许多需要攻克的问题，如：通讯异常、网络分区、三态、节点故障等。

### 通讯异常
网络系统本身是不可靠的，由于分布式系统需要通过网络进行数据传输，网络光纤、路由器等硬件难免出现问题。网络出现问题，会影响消息的发送与接受过程，因此数据消息的丢失或者延长就会变得非常普遍。

### 网络分区
由于种种问题导致同一个区域（分布式集群）有两个相互冲突的负责人，这时候就会出现这种精神分裂的情况，称为脑裂，也叫网络分区。

### 三态
分布式系统调用的三态：成功、失败和超时。

### 节点故障
节点故障在分布式系统下是比较常见的问题，指的是组成服务器集群的节点会出现的宕机或“僵死”的现象。

## 2.2 CAP 理论
在一个分布式系统（指互相连接并共享数据节点的集合）中，当涉及读写操作时，只能保证一致性（``Consistence``）、可用性（``Availability``）、分区容错性（``Partition Tolerance``）三者中的两个，另外一个必须被牺牲。

- 一致性（``Consistence``）：对某个指定的客户端来说，读操作保证能够返回最新的写操作结果。
- 可用性（``Availability``）：非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）。
- 分区容错性（``Partition Tolerance``）：当出现网络分区后，系统能够继续履行职责。

### CAP 应用
虽然 CAP 理论定义是三个要素中只能取两个，但放到分布式环境下来思考，我们会发现必须选择 P(分区容错)要素，因为**网络本身无法做到 100% 可靠，有可能出故障，所以分区是一个必然的现象**。

结论反推：如果选择了 CA 而放弃了 P，当发生分区现象时，为了保证 C，系统需要禁止写入，当有写入请求时，系统返回 error 和 A 冲突了，因为 A 要求返回 no error 和 no timeout。因此，分布式系统理论上不可能选择 CA 架构，只能选择 CP 或者 AP 架构。

- **CP**：如下图，为了保证一致性，当发生分区现象后，N1 节点上的数据已经更新到 y，但由于 N1 和 N2 之间的复制通道中断，数据 y 无法同步到 N2，N2 节点上的数据还是 x。这时客户端 C 访问 N2 时，N2 需要返回 Error，提示客户端面 C：“系统现在发生错误”，这种处理方式违背了可用性（Availability）的要求，因此 CAP 三者只能满足 CP。
    
<img src=".\images\102.png" alt="101"  />
    
    
    
- **AP**：如下图，为了保证可用性，当发生分区现象后，N1 节点上的数据已经更新到 y，但由于 N1 和 N2 之间的复制通道中断，数据 y 无法同步到 N2，N2 节点上的数据还是 x。这时客户 C 访问 N2 时，N2 将当前自己拥有的数据 x 返回给客户端 C 了，而实际上当前最新的数据已经是 y 了，这就不满足一致性（Consistency）的要求，因此 CAP 三者只能满足 AP。

    注：这里 N2 节点返回的 x，虽然不是一个“正确”的结果，但是一个“合理”的结果，因为 x 是旧的数据，并不是一个错乱的值，只是不是最新的数据而已。
    
    <img src=".\images\103.png" alt="101"  />

架构师应该从一致性和可用性之间找平衡，系统短时间完全不可用肯定是不允许的；根据 CAP 理论，在分布式环境下必然也无法做到强一致性。

## 2.3 ACID
ACID 是数据库管理系统为了保证事务的正确性而提出来的一个理论，ACID 包含四个约束：

- ``Atomicity``（原子性）：一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。
- ``Consistency``（一致性）：在事务开始之前和事务结束以后，数据库的完整性约束没有被破坏。
- ``Isolation``（隔离性）：数据库允许多个并发事务同时对数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离级别分为：读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。
- ``Durability``（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

ACID 的应用场景是数据库事务，而 CAP 关注的是分布式系统数据读写。

## 2.4 BASE 理论
BASE 理论是指基本可用（``Basically Available``）、软状态（ ``Soft State``）、最终一致性（``Eventual Consistency``），核心思想是**即使无法做到强一致性（CAP 的一致性就是强一致性），但分布式系统可以根据自己的业务特点，采用适当的方式来使系统达到最终的一致性**。

- **基本可用**：分布式系统在出现故障时，允许损失**部分**可用性，即保证**核心**可用。
- **软状态**：允许系统存在中间状态，而该中间状态不会影响系统整体可用性。（中间状态就是 CAP 理论中的数据不一致）
- **最终一致性**：系统中的所有数据副本经过**一定时间**后，**最终**能够达到一致的状态。

BASE 理论本质上是对 CAP 的延伸和补充，更具体地说，是对 CAP 中 AP 方案的一个补充：
- CAP 理论是忽略延时的，而实际应用中延时是无法避免的。
- AP 方案中牺牲一致性只是指分区期间，而不是永远放弃一致性。

# 参考
- [什么是分布式系统，如何学习分布式系统](https://www.cnblogs.com/xybaby/p/7787034.html)
- [分布式学习最佳实践：从分布式系统的特征开始（附思维导图）](https://www.cnblogs.com/xybaby/p/8544715.html#_labelTop)
- [成为架构师，你必须知道的CAP理论](https://www.jianshu.com/p/bf3c47842f29)